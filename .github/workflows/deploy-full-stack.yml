name: Deploy Full Stack

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'pcweb/**'
      - 'shared/**'
      - 'nginx/**'
      - 'docker-compose.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Copy all files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: mirainest.asuscomm.com
          username: zerone6
          key: ${{ secrets.DEPLOY_KEY }}
          source: "."
          target: "~/app/"
          overwrite: true
          rm: true
      
      - name: Deploy full stack
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: mirainest.asuscomm.com
          username: zerone6
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd ~/app
            
            # DNS 설정 강화
            echo "=== DNS Configuration ==="
            echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
            echo "nameserver 1.1.1.1" | sudo tee -a /etc/resolv.conf
            echo "nameserver 208.67.222.222" | sudo tee -a /etc/resolv.conf
            
            # 네트워크 연결 테스트 (더 강화된 테스트)
            echo "=== Network Test ==="
            ping -c 3 8.8.8.8 || echo "Google DNS ping failed"
            dig @8.8.8.8 registry.npmjs.org || echo "NPM registry DNS lookup failed"
            dig @8.8.8.8 repo.maven.apache.org || echo "Maven repo DNS lookup failed"
            curl -I --connect-timeout 10 --max-time 30 https://registry.npmjs.org/ || echo "NPM registry connection failed"
            curl -I --connect-timeout 10 --max-time 30 https://repo.maven.apache.org/maven2/ || echo "Maven repo connection failed"
            
            # Docker 데몬 상태 확인
            sudo systemctl status docker || echo "Docker status check failed"
            
            # 네트워크 생성 (이미 존재하면 무시)
            docker network create app-network || true
            
            # 기존 컨테이너 정리
            docker compose down --remove-orphans || true
            
            # 오래된 이미지 정리
            docker image prune -f || true
            
            # Docker 빌드 시 DNS 설정 적용
            export DOCKER_BUILDKIT=1
            export BUILDKIT_PROGRESS=plain
            
            # 홈서버 환경을 위한 네트워크 설정
            echo "=== Docker Network Configuration ==="
            docker network ls
            
            # Backend 빌드 및 실행 (더 강화된 DNS 설정)
            echo "=== Building Backend ==="
            DOCKER_BUILDKIT=1 docker build --network=host --no-cache \
              --add-host=repo.maven.apache.org:151.101.64.215 \
              --add-host=repo1.maven.org:151.101.64.215 \
              --add-host=registry.npmjs.org:104.16.30.34 \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              -t realestate-backend ./backend || {
                echo "Backend build failed, retrying..."
                sleep 30
                DOCKER_BUILDKIT=1 docker build --network=host --no-cache \
                  --add-host=repo.maven.apache.org:151.101.64.215 \
                  --add-host=repo1.maven.org:151.101.64.215 \
                  -t realestate-backend ./backend
              }
            docker compose up -d backend
            
            # Backend 헬스체크
            echo "=== Backend Health Check ==="
            for i in {1..30}; do
              if curl -f http://localhost:8080/api/calculation/health 2>/dev/null; then
                echo "Backend is healthy"
                break
              fi
              echo "Waiting for backend... ($i/30)"
              sleep 2
            done
            
            # Frontend 빌드 및 실행 (더 강화된 재시도 메커니즘)
            echo "=== Building Frontend ==="
            DOCKER_BUILDKIT=1 docker build --network=host --no-cache \
              --add-host=registry.npmjs.org:104.16.30.34 \
              --add-host=registry.yarnpkg.com:104.16.30.34 \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              -t realestate-pcweb -f ./pcweb/Dockerfile . || {
                echo "Frontend build failed, retrying..."
                sleep 30
                # 캐시 클리어 후 재시도
                docker system prune -f
                DOCKER_BUILDKIT=1 docker build --network=host --no-cache \
                  --add-host=registry.npmjs.org:104.16.30.34 \
                  -t realestate-pcweb -f ./pcweb/Dockerfile .
              }
            docker compose up -d pcweb
            
            # Frontend 대기
            sleep 10
            
            # Nginx 실행
            echo "=== Starting Nginx ==="
            docker compose up -d nginx
            
            # 최종 상태 확인
            sleep 5
            echo "=== Container Status ==="
            docker compose ps
            
            echo "=== Frontend Check ==="
            if curl -f http://localhost:3001 2>/dev/null; then
              echo "Frontend is accessible"
            else
              echo "Frontend check failed"
              echo "Frontend logs:"
              docker compose logs pcweb --tail=10
            fi
            
            echo "=== Nginx Check ==="
            if curl -f http://localhost/ 2>/dev/null; then
              echo "Nginx is accessible"
            else
              echo "Nginx check failed"
              echo "Nginx logs:"
              docker compose logs nginx --tail=10
            fi
